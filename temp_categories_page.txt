"use client";

import React, { useEffect, useState, useCallback } from "react";
import {
  Edit,
  Trash2,
  Plus,
  Search,
  Package,
  ChevronRight,
  ArrowLeft,
  ArrowRight,
  FolderOpen,
  Box,
  Tag,
  Image as ImageIcon,
  Calendar,
  DollarSign,
  ShoppingCart,
} from "lucide-react";
import { useTranslation } from "../../../hooks/useTranslation";
import { useAppDispatch, useAppSelector } from "../../../store/hooks";
import {
  getMaterialCategories,
  createMaterialCategory,
  updateMaterialCategory,
  deleteMaterialCategory,
  clearError as clearCategoryError,
  MaterialCategory,
  CreateMaterialCategoryData,
  UpdateMaterialCategoryData,
} from "../../../store/slices/materialCategoriesSlice";
import {
  getMaterials,
  createMaterial,
  updateMaterial,
  deleteMaterial,
  clearError as clearMaterialError,
  Material,
  CreateMaterialData,
  UpdateMaterialData,
} from "../../../store/slices/materialsSlice";
import {
  getListings,
  createListing,
  updateListing,
  deleteListing,
  clearError as clearListingError,
  Listing,
  CreateListingData,
  UpdateListingData,
} from "../../../store/slices/listingsSlice";
import {
  Card,
  CardHeader,
  CardTitle,
  CardDescription,
  CardContent,
} from "../../../components/ui/Card";
import { Button } from "../../../components/ui/Button";
import { Input } from "../../../components/ui/Input";
import { Badge } from "../../../components/ui/Badge";
import {
  Table,
  TableHeader,
  TableBody,
  TableRow,
  TableHead,
  TableCell,
} from "../../../components/ui/Table";
import { CategoryFormDialog } from "../../../components/admin/CategoryFormDialog";
import { MaterialFormDialog } from "../../../components/admin/MaterialFormDialog";
import { DeleteConfirmDialog } from "../../../components/admin/DeleteConfirmDialog";
import { ListingFormDialog } from "../../../components/ListingFormDialog";
import { Toast } from "../../../components/ui/Toast";
import { cn } from "../../../lib/utils";
import Image from "next/image";

type ViewMode = "categories" | "materials" | "listings";

export default function MaterialsManagement() {
  const { t, currentLanguage } = useTranslation();
  const dispatch = useAppDispatch();
  const isRTL = currentLanguage.code === "ar";

  const {
    categories,
    isLoading: categoriesLoading,
    error: categoriesError,
  } = useAppSelector((state) => state.materialCategories);
  const {
    materials,
    isLoading: materialsLoading,
    error: materialsError,
  } = useAppSelector((state) => state.materials);
  const {
    listings,
    isLoading: listingsLoading,
    error: listingsError,
  } = useAppSelector((state) => state.listings);

  const [viewMode, setViewMode] = useState<ViewMode>("categories");
  const [selectedCategory, setSelectedCategory] =
    useState<MaterialCategory | null>(null);
  const [selectedMaterial, setSelectedMaterial] = useState<Material | null>(
    null
  );
  const [searchQuery, setSearchQuery] = useState("");

  // Dialog states
  const [categoryFormOpen, setCategoryFormOpen] = useState(false);
  const [materialFormOpen, setMaterialFormOpen] = useState(false);
  const [listingFormOpen, setListingFormOpen] = useState(false);
  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);
  const [editingCategory, setEditingCategory] =
    useState<MaterialCategory | null>(null);
  const [editingMaterial, setEditingMaterial] = useState<Material | null>(null);
  const [editingListing, setEditingListing] = useState<Listing | null>(null);
  const [deletingItem, setDeletingItem] = useState<{
    type: "category" | "material" | "listing";
    item: MaterialCategory | Material | Listing;
  } | null>(null);

  const [toast, setToast] = useState<{
    message: string;
    type: "success" | "error";
  } | null>(null);

  useEffect(() => {
    dispatch(getMaterialCategories());
  }, [dispatch]);

  useEffect(() => {
    if (categoriesError) {
      setToast({ message: categoriesError, type: "error" });
      dispatch(clearCategoryError());
    }
    if (materialsError) {
      setToast({ message: materialsError, type: "error" });
      dispatch(clearMaterialError());
    }
    if (listingsError) {
      setToast({ message: listingsError, type: "error" });
      dispatch(clearListingError());
    }
  }, [categoriesError, materialsError, listingsError, dispatch]);

  // Category handlers
  const handleAddCategory = () => {
    setEditingCategory(null);
    setCategoryFormOpen(true);
  };

  const handleEditCategory = (category: MaterialCategory) => {
    setEditingCategory(category);
    setCategoryFormOpen(true);
  };

  const handleDeleteCategory = (category: MaterialCategory) => {
    setDeletingItem({ type: "category", item: category });
    setDeleteDialogOpen(true);
  };

  const handleViewMaterials = async (category: MaterialCategory) => {
    setSelectedCategory(category);
    setViewMode("materials");
    setSearchQuery("");
    try {
      await dispatch(getMaterials({ categoryId: category.id })).unwrap();
    } catch (err) {
      console.error("Error fetching materials:", err);
      setToast({ message: t("admin.error"), type: "error" });
    }
  };

  const handleSubmitCategory = async (
    data: CreateMaterialCategoryData | UpdateMaterialCategoryData
  ) => {
    try {
      if (editingCategory) {
        await dispatch(
          updateMaterialCategory({
            id: editingCategory.id,
            data: data as UpdateMaterialCategoryData,
          })
        ).unwrap();
        setToast({
          message: t("admin.categoryUpdatedSuccess"),
          type: "success",
        });
      } else {
        await dispatch(
          createMaterialCategory(data as CreateMaterialCategoryData)
        ).unwrap();
        setToast({
          message: t("admin.categoryCreatedSuccess"),
          type: "success",
        });
      }
      setCategoryFormOpen(false);
      dispatch(getMaterialCategories());
    } catch (err) {
      setToast({ message: t("admin.error"), type: "error" });
    }
  };

  // Material handlers
  const handleAddMaterial = () => {
    setEditingMaterial(null);
    setMaterialFormOpen(true);
  };

  const handleEditMaterial = (material: Material) => {
    setEditingMaterial(material);
    setMaterialFormOpen(true);
  };

  const handleDeleteMaterial = (material: Material) => {
    setDeletingItem({ type: "material", item: material });
    setDeleteDialogOpen(true);
  };

  const handleViewListings = async (material: Material) => {
    setSelectedMaterial(material);
    setViewMode("listings");
    setSearchQuery("");
    try {
      await dispatch(getListings({ materialId: material.id })).unwrap();
    } catch (err) {
      console.error("Error fetching listings:", err);
      setToast({ message: t("admin.error"), type: "error" });
    }
  };

  const handleSubmitMaterial = async (
    data: CreateMaterialData | UpdateMaterialData
  ) => {
    try {
      if (editingMaterial) {
        await dispatch(
          updateMaterial({
            id: editingMaterial.id,
            data: data as UpdateMaterialData,
          })
        ).unwrap();
        setToast({
          message: t("admin.materialUpdatedSuccess"),
          type: "success",
        });
      } else {
        await dispatch(createMaterial(data as CreateMaterialData)).unwrap();
        setToast({
          message: t("admin.materialCreatedSuccess"),
          type: "success",
        });
      }
      setMaterialFormOpen(false);
      if (selectedCategory) {
        dispatch(getMaterials({ categoryId: selectedCategory.id }));
      }
    } catch (err) {
      setToast({ message: t("admin.error"), type: "error" });
    }
  };

  // Listing handlers
  const handleAddListing = () => {
    setEditingListing(null);
    setListingFormOpen(true);
  };

  const handleEditListing = (listing: Listing) => {
    setEditingListing(listing);
    setListingFormOpen(true);
  };

  const handleDeleteListing = (listing: Listing) => {
    setDeletingItem({ type: "listing", item: listing });
    setDeleteDialogOpen(true);
  };

  const handleSubmitListing = async (data: CreateListingData) => {
    try {
      if (!selectedMaterial) {
        setToast({ message: t("admin.error"), type: "error" });
        return;
      }

      // Set materialId from selected material
      const listingData: CreateListingData = {
        ...data,
        materialId: selectedMaterial.id,
      };

      if (editingListing) {
        // Update existing listing
        await dispatch(
          updateListing({
            id: editingListing.id,
            data: listingData as UpdateListingData,
          })
        ).unwrap();
        setToast({
          message:
            t("listing.listingUpdatedSuccess") ||
            "Listing updated successfully",
          type: "success",
        });
      } else {
        // Create new listing
        await dispatch(createListing(listingData)).unwrap();
        setToast({
          message:
            t("listing.listingCreatedSuccess") ||
            "Listing created successfully",
          type: "success",
        });
      }
      setListingFormOpen(false);
      setEditingListing(null);
      // Refresh listings
      if (selectedMaterial) {
        dispatch(getListings({ materialId: selectedMaterial.id }));
      }
    } catch (err: any) {
      setToast({
        message: err.message || t("admin.error"),
        type: "error",
      });
    }
  };

  // Delete handler
  const handleConfirmDelete = async () => {
    if (!deletingItem) return;

    try {
      if (deletingItem.type === "category") {
        await dispatch(deleteMaterialCategory(deletingItem.item.id)).unwrap();
        setToast({
          message: t("admin.categoryDeletedSuccess"),
          type: "success",
        });
        dispatch(getMaterialCategories());
      } else if (deletingItem.type === "material") {
        await dispatch(deleteMaterial(deletingItem.item.id)).unwrap();
        setToast({
          message: t("admin.materialDeletedSuccess"),
          type: "success",
        });
